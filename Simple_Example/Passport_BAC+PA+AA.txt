# Passive and Active Authentification
# We test the anonimity of PA|AA for one session (one session with a compromised passport + 1 normal session)
# SHOULD BE TRUE


free c.
#first session
free c1.
free cp1p.
free cp1a.
free cr1p.
free cr1a.
#second session
free c2.
free cp2p.
free cp2a.
free cr2p.
free cr2a.

fun h/1.
fun mac/2.
fun read/0.
fun init/0.
fun ok/0.

# Description of the different roles.

let PApassport ksenc ksmac dg sod c = 
  in(c, x);
  let (xenc, xmac) = x in 
  if xmac = mac(xenc, ksmac) 
  then
    let xread = sdec(xenc,ksenc) in
    if xread = read
    then
      let menc = senc((dg, sod),ksenc) in
      let mmac = mac(menc,ksmac) in
      out(c, (menc,mmac))
    else 0
  else 0.

let PAreader KPrDS ksenc ksmac c =
  let menc = senc(read,ksenc) in
  let mmac = mac(menc,ksmac) in
  in(c,zz);
  out(c, (menc, mmac));
  in(c,x);
  let (xenc, xmac) = x in 
  if xmac = mac(xenc, ksmac) 
  then(let (xdg,xsod) = sdec(xenc,ksenc) in
       let (xhdg, xshdg) = xsod i
       if xshdg = checksign(xshdg, (pk(KPrDS)))
       then (if xhdg = h(xdg)
             then out(c, ok)
             else 0)
       else 0)
  else 0.
  
let AApassport ksenc ksmac skP c = 
  in(c, x);
  let (xenc, xmac) = x in 
  if xmac = mac(xenc, ksmac) 
  then
    let (xinit, xrnd) = sdec(xenc,ksenc) in
    if xinit = init
    then
      new nce;
      let sigma = sign((nce,xrnd),skP) in
      let menc = senc(sigma,ksenc) in
      let mmac = mac(menc,ksmac) in
      out(c, (menc,mmac))
    else 0
  else 0.

let AAreader ksenc ksmac pkP c =
  new rnd;
  let menc = senc((init,rnd),ksenc) in
  let mmac = mac(menc,ksmac) in
  in(c,zz);
  out(c, (menc, mmac));
  in(c,x);
  let (xenc, xmac) = x in 
  if xmac = mac(xenc, ksmac) 
  then
    let (xnce, xrnd) = sdec(xenc,ksenc) in
    if xrnd = rnd
    then out(c,ok)
    else 0
  else 0.

let ePassport KPrDS cp1p cr1p cp1a cr1a =
  new ksenc;
  new ksmac;
  new skP;
  new dg;
  let sod = (h(dg), sign(h(dg),KPrDS)) in
  ((PAreader KPrDS ksenc ksmac cr1p | PApassport ksenc ksmac dg sod cp1p) 
 |
  (AAreader ksenc ksmac pk(skP) cr1a | AApassport ksenc ksmac skP cp1a)).

let ePassportLeak KPrDS skP dg sod cp1p cr1p cp1a cr1a =
  new ksenc;
  new ksmac;
  ((PAreader KPrDS ksenc ksmac cr1p | PApassport ksenc ksmac dg sod cp1p) 
 |
  (AAreader ksenc ksmac pk(skP) cr1a | AApassport ksenc ksmac skP cp1a)).
    
# Main systems.
let wholeSystem_L = 
  new KPrDS;
  let KPuDS = pk(KPrDS) in
      	    #The leak of the compromised passport
  new skP;
  new dg;
  let sod = (h(dg), sign(h(dg),KPrDS)) in
  in(c,zz);
  out(c,KPuDS);
  out(c,(dg,sod,skP));
  ((ePassport KPrDS cp1p cr1p cp1a cr1a)
 |
   (ePassport KPrDS cp2p cr2p cp2a cr2a)).

let wholeSystem_R = 
  new KPrDS;
  let KPuDS = pk(KPrDS) in
      	    #The leak of the compromised passport
  new skP;
  new dg;
  let sod = (h(dg), sign(h(dg),KPrDS)) in
  in(c,zz);
  out(c,KPuDS);
  out(c,(dg,sod,skP));
  ((ePassport KPrDS cp1p cr1p cp1a cr1a )
  |
  (ePassportLeak KPrDS skP dg sod cp2p cr2p cp2a cr2a)).

equivalence wholeSystem_L and wholeSystem_R.
